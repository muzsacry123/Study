name: "CodeQL Multi-language Analysis"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  security-events: write

jobs:
  python:
    name: Python CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect Python files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "python/**/*.py" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Set up Python
        if: env.present == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install system dependencies
        if: env.present == 'true'
        run: sudo apt-get update && sudo apt-get install -y libcairo2-dev libgirepository1.0-dev gir1.2-pango-1.0 python3-gi-cairo

      - name: Initialize CodeQL
        if: env.present == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Install python deps
        if: env.present == 'true'
        run: |
          if [ -f "python/requirements.txt" ]; then
            pip install -r python/requirements.txt
          fi
      
      - name: Perform CodeQL Analysis
        if: env.present == 'true'
        uses: github/codeql-action/analyze@v4

  java:
    name: Java/Kotlin CodeQL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect Java files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "java/**/*.java" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Initialize CodeQL
        if: env.present == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: java

      - name: Build all Java subprojects
        if: env.present == 'true'
        run: |
          shopt -s globstar
          for proj in java/**/build.gradle.kts; do
            dir=$(dirname "$proj")
            echo "Building Java project in $dir"
            (cd "$dir" && ./gradlew build)
          done

      - name: Perform CodeQL Analysis
        if: env.present == 'true'
        uses: github/codeql-action/analyze@v4

  cpp:
    name: C/C++ CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect C/C++ files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "cpp/**/*.c" > /dev/null || compgen -G "cpp/**/*.cpp" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Initialize CodeQL
        if: env.present == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Build C/C++
        if: env.present == 'true'
        run: |
          cd cpp
          if [ -f "CMakeLists.txt" ]; then
            mkdir -p build && cd build && cmake .. && cmake --build .
          elif [ -f "Makefile" ]; then
            make
          else
            echo "No C/C++ build tool."
          fi

      - name: Perform CodeQL Analysis
        if: env.present == 'true'
        uses: github/codeql-action/analyze@v4

  csharp:
    name: C# CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect C# files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "csharp/**/*.cs" > /dev/null || compgen -G "csharp/**/*.csproj" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Initialize CodeQL
        if: env.present == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: csharp

      - name: Build C#
        if: env.present == 'true'
        run: |
          for proj in csharp/**/*.csproj; do
            [ -f "$proj" ] && dotnet build "$proj"
          done

      - name: Perform CodeQL Analysis
        if: env.present == 'true'
        uses: github/codeql-action/analyze@v4

  javascript:
    name: JavaScript/TypeScript CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect JS/TS files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "javascript/**/*.js" > /dev/null || compgen -G "javascript/**/*.ts" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Initialize CodeQL
        if: env.present == 'true'
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: npm install
        if: env.present == 'true'
        run: |
          if [ -f "javascript/package.json" ]; then
            cd javascript && npm install
          fi

      - name: Perform CodeQL Analysis
        if: env.present == 'true'
        uses: github/codeql-action/analyze@v4
