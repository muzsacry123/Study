name: "CodeQL Multi-language Analysis"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  security-events: write

jobs:
  python:
    name: Python CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect machine_learning Python files
        id: check_ml
        run: |
          shopt -s globstar
          if compgen -G "python/machine_learning/**/*.py" > /dev/null; then
            echo "ml_present=true" >> $GITHUB_ENV
          else
            echo "ml_present=false" >> $GITHUB_ENV
          fi

      - name: Detect manim Python files
        id: check_manim
        run: |
          shopt -s globstar
          if compgen -G "python/manim/**/*.py" > /dev/null; then
            echo "manim_present=true" >> $GITHUB_ENV
          else
            echo "manim_present=false" >> $GITHUB_ENV
          fi
      
      - name: Get modified files
        id: files
        run: |
          # 获取变化文件列表
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD)
          else
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "Changed files:"
          echo "$changed_files"

          # 设置环境变量
          echo "changed_files=$changed_files" >> $GITHUB_ENV

          # 设置布尔值，如果为空就表示没有修改
          echo "actual_changes=false" >> $GITHUB_ENV
          for file in $changed_files; do
            case "$file" in
              *.py)
                echo "actual_changes=true" >> $GITHUB_ENV
                break  # 找到一个就可以退出循环
                ;;
            esac
          done

      ########################
      # Machine Learning
      ########################
      - name: Set up Python 3.9 for machine_learning
        if: ${{ env.ml_present == 'true' && env.actual_changes == 'true' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install machine_learning dependencies
        if: ${{ env.ml_present == 'true' && env.actual_changes == 'true' }}
        run: |
          pip install -r python/machine_learning/requirements.txt || true

      - name: Initialize CodeQL for machine_learning
        if: ${{ env.ml_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Analyze machine_learning
        if: ${{ env.ml_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-machine_learning.sarif
          category: python_machine_learning
          paths: ${{ env.changed }}
          upload: false

      - name: Upload machine_learning results
        if: ${{ env.ml_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-machine_learning.sarif

      ########################
      # Manim
      ########################
      - name: Set up Python 3.10 for manim
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies for manim
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libcairo2-dev libpango1.0-dev

      - name: Install manim dependencies
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        run: |
          pip install -r python/manim/requirements.txt || true

      - name: Initialize CodeQL for manim
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Analyze manim
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-manim.sarif
          category: python_manim
          paths: ${{ env.changed }}
          upload: false

      - name: Upload manim results
        if: ${{ env.manim_present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-manim.sarif


  java:
    name: Java/Kotlin CodeQL
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Java files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "java/**/*.java" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi

      - name: Get modified files
        id: files
        if: env.present == 'true'
        run: |
          # 获取变化文件列表
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD)
          else
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "Changed files:"
          echo "$changed_files"

          # 设置环境变量
          echo "changed_files=$changed_files" >> $GITHUB_ENV

          # 设置布尔值，如果为空就表示没有修改
          echo "actual_changes=false" >> $GITHUB_ENV
          for file in $changed_files; do
            case "$file" in
              *.java)
                echo "actual_changes=true" >> $GITHUB_ENV
                break  # 找到一个就可以退出循环
                ;;
            esac
          done

      - name: Initialize CodeQL
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: java

      - name: Build all Java subprojects
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        run: |
          shopt -s globstar
          found_build=false
          for dir in java/*; do
            if [ -f "$dir/gradlew" ]; then
              echo "Building Java project in $dir using gradlew"
              cd "$dir"
              chmod +x ./gradlew
              ./gradlew build
              cd -
              found_build=true
            elif [ -f "$dir/build.gradle" ]; then
              echo "Building Java project in $dir using gradle wrapper"
              cd "$dir"
              gradle build
              cd -
              found_build=true
            elif [ -f "$dir/build.gradle.kts" ]; then
              echo "Building Java project in $dir using gradle wrapper (Kotlin DSL)"
              cd "$dir"
              gradle build
              cd -
              found_build=true
            fi
          done
          if [ "$found_build" = false ]; then
            echo "No Java build tool found in any subdirectory, skipping build"
          fi

      - name: Perform CodeQL Analysis
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-java.sarif
          paths: ${{ env.changed }}
          upload: false
      - name: Upload CodeQL results
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-java.sarif

  cpp:
    name: C/C++ CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect C/C++ files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "cpp/**/*.c" > /dev/null || compgen -G "cpp/**/*.cpp" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi
      
      - name: Get modified files
        id: files
        if: env.present == 'true'
        run: |
          # 获取变化文件列表
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD)
          else
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "Changed files:"
          echo "$changed_files"

          # 设置环境变量
          echo "changed_files=$changed_files" >> $GITHUB_ENV

          # 设置布尔值，如果为空就表示没有修改
          echo "actual_changes=false" >> $GITHUB_ENV
          for file in $changed_files; do
            case "$file" in
              *.c|*.cpp|*.h|*.hpp)
                echo "actual_changes=true" >> $GITHUB_ENV
                break  # 找到一个就可以退出循环
                ;;
            esac
          done

      - name: Initialize CodeQL
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Build C/C++
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        run: |
          cd cpp
          if [ -f "CMakeLists.txt" ]; then
            mkdir -p build && cd build && cmake .. && cmake --build .
          elif [ -f "Makefile" ]; then
            make
          else
            echo "No C/C++ build tool."
          fi

      - name: Perform CodeQL Analysis
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-cpp.sarif
          paths: ${{ env.changed }}
          upload: false
      - name: Upload CodeQL results
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-cpp.sarif

  csharp:
    name: C# CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect C# files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "csharp/**/*.cs" > /dev/null || compgen -G "csharp/**/*.csproj" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi
      
      - name: Get modified files
        id: files
        if: env.present == 'true'
        run: |
          # 获取变化文件列表
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD)
          else
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "Changed files:"
          echo "$changed_files"

          # 设置环境变量
          echo "changed_files=$changed_files" >> $GITHUB_ENV

          # 设置布尔值，如果为空就表示没有修改
          echo "actual_changes=false" >> $GITHUB_ENV
          for file in $changed_files; do
            case "$file" in
              *.cs|*.csproj)
                echo "actual_changes=true" >> $GITHUB_ENV
                break  # 找到一个就可以退出循环
                ;;
            esac
          done

      - name: Initialize CodeQL
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: csharp

      - name: Build C#
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        run: |
          for proj in csharp/**/*.csproj; do
            [ -f "$proj" ] && dotnet build "$proj"
          done

      - name: Perform CodeQL Analysis
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-csharp.sarif
          paths: ${{ env.changed }}
          upload: false
      - name: Upload CodeQL results
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-csharp.sarif

  javascript:
    name: JavaScript/TypeScript CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect JS/TS files
        id: check
        run: |
          shopt -s globstar
          if compgen -G "javascript/**/*.js" > /dev/null || compgen -G "javascript/**/*.ts" > /dev/null; then
            echo "present=true" >> $GITHUB_ENV
          else
            echo "present=false" >> $GITHUB_ENV
          fi
      
      - name: Get modified files
        id: files
        if: env.present == 'true'
        run: |
          # 获取变化文件列表
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }} HEAD)
          else
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          fi
          echo "Changed files:"
          echo "$changed_files"

          # 设置环境变量
          echo "changed_files=$changed_files" >> $GITHUB_ENV

          # 设置布尔值，如果为空就表示没有修改
          echo "actual_changes=false" >> $GITHUB_ENV
          for file in $changed_files; do
            case "$file" in
              *.js|*.ts)
                echo "actual_changes=true" >> $GITHUB_ENV
                break  # 找到一个就可以退出循环
                ;;
            esac
          done
          
      - name: Initialize CodeQL
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: npm install
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        run: |
          if [ -f "javascript/package.json" ]; then
            cd javascript && npm install
          fi

      - name: Perform CodeQL Analysis
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/analyze@v4
        with:
          output: results-js.sarif
          paths: ${{ env.changed }}
          upload: false
      - name: Upload CodeQL results
        if: ${{ env.present == 'true' && env.actual_changes == 'true' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results-js.sarif
