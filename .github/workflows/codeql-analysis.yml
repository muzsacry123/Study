name: "CodeQL Multi-language Analysis"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  security-events: write

jobs:
  python:
    name: Python CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: contains(join(github.event.head_commit.message, ' '), '') # 自动跳过空仓库时可改进逻辑
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt, skipping install"
          fi

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4
        with:
          build-command: 'echo "Python, no build needed"'

      - name: Perform CodeQL Analysis
        if: contains(github.workspace, '*.py')
        uses: github/codeql-action/analyze@v4

  java:
    name: Java/Kotlin CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Java code exists
        id: check_java
        run: |
          shopt -s globstar
          if compgen -G "**/*.java" > /dev/null; then
            echo "java_present=true" >> $GITHUB_ENV
          else
            echo "java_present=false" >> $GITHUB_ENV
          fi
      
      - name: Skip if no Java code
        if: env.java_present == 'false'
        run: |
          echo "No Java code found, skipping job."
          exit 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java

      - name: Build Java project
        run: |
          if [ -f "pom.xml" ]; then
            mvn clean package
          elif [ -f "build.gradle" ]; then
            ./gradlew build
          else
            echo "No Java build tool found, skipping build"
          fi

      - name: Perform CodeQL Analysis
        if: contains(github.workspace, '*.java')
        uses: github/codeql-action/analyze@v4

  cpp:
    name: C/C++ CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if C/C++ code exists
        id: check_cpp
        run: |
          shopt -s globstar
          if compgen -G "**/*.c" > /dev/null || compgen -G "**/*.cpp" > /dev/null; then
            echo "cpp_present=true" >> $GITHUB_ENV
          else
            echo "cpp_present=false" >> $GITHUB_ENV
          fi
  
      - name: Skip if no C/C++ code
        if: env.cpp_present == 'false'
        run: |
          echo "No C/C++ code found, skipping job."
          exit 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: cpp

      - name: Build C/C++
        run: |
          if [ -f "CMakeLists.txt" ]; then
            mkdir -p build
            cd build
            cmake ..
            cmake --build .
          elif [ -f "Makefile" ]; then
            make
          else
            echo "No C/C++ build tool detected. Skipping build"
          fi

      - name: Perform CodeQL Analysis
        if: contains(github.workspace, '*.c') || contains(github.workspace, '*.cpp')
        uses: github/codeql-action/analyze@v4

  csharp:
    name: C# CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Skip if no C# code
        run: |
          shopt -s globstar
          if compgen -G "**/*.csproj" > /dev/null || compgen -G "**/*.cs" > /dev/null; then
            echo "csharp_present=true" >> $GITHUB_ENV
          else
            echo "csharp_present=false" >> $GITHUB_ENV
          fi

      - name: Skip if no C# code
        if: env.csharp_present == 'false'
        run: |
          echo "No C# code found, skipping CodeQL analysis"
          exit 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp

      - name: Build C# projects
        run: |
          shopt -s globstar
          found=false
          for proj in **/*.csproj; do
            if [ -f "$proj" ]; then
              echo "Building $proj"
              dotnet build "$proj"
              found=true
            fi
          done
          if [ "$found" = false ]; then
            echo "No .csproj files found, skipping build"
          fi

      - name: Perform CodeQL Analysis
        if: contains(github.workspace, '*.csproj') || contains(github.workspace, '*.cs')
        uses: github/codeql-action/analyze@v4

  javascript:
    name: JavaScript/TypeScript CodeQL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if JS/TS code exists
        id: check_js
        run: |
          shopt -s globstar
          if compgen -G "**/*.js" > /dev/null || compgen -G "**/*.ts" > /dev/null; then
            echo "js_present=true" >> $GITHUB_ENV
          else
            echo "js_present=false" >> $GITHUB_ENV
          fi

      - name: Skip if no JS/TS code
        if: env.js_present == 'false'
        run: |
          echo "No JavaScript or TypeScript code found, skipping CodeQL analysis"
          exit 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript

      - name: Build JS/TS (npm install)
        run: |
          if [ -f "package.json" ]; then
            npm install
          else
            echo "No package.json found, skipping npm install"
          fi

      - name: Autobuild placeholder
        uses: github/codeql-action/autobuild@v4
        with:
          build-command: 'echo "No extra build needed"'

      - name: Perform CodeQL Analysis
        if: contains(github.workspace, '*.js') || contains(github.workspace, '*.ts')
        uses: github/codeql-action/analyze@v4
